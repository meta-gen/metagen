<div th:fragment="grid(tableId, dataUrl, crudActions)">
    <div class="grid-header">
        <!-- 검색창 + 컬럼 선택 + 조회 버튼 -->
        <div class="search-container">
            <!-- 검색 컬럼 선택 드롭다운 -->
            <select class="search-column-select" th:data-table-id="${tableId}" th:id="'search-column-' + ${tableId}">
            </select>

            <!-- 검색 입력 필드 (초기 기본값: STRING 타입) -->
            <input type="text" class="search-input-text search-input" th:data-table-id="${tableId}" th:id="'search-input-text-' + ${tableId}" placeholder="검색어 입력">
            <input type="number" class="search-input-number search-input" th:data-table-id="${tableId}" th:id="'search-input-number-' + ${tableId}" placeholder="숫자만 입력하세요" style="display: none;">

            <button class="grd-select" th:data-table-id="${tableId}" th:id="'grd-select-' + ${tableId}">조회</button>
        </div>

        <!-- 승인, 추가, 저장, 삭제 버튼 -->
        <div class="button-container">
            <button class="grd-active" th:data-table-id="${tableId}" th:id="'grd-active-' + ${tableId}" style="display: none;">승인</button>
            <button class="grd-add" th:data-table-id="${tableId}" th:id="'grd-add-' + ${tableId}" style="display: none;">추가</button>
            <button class="grd-save" th:data-table-id="${tableId}" th:id="'grd-save-' + ${tableId}" style="display: none;">저장</button>
            <button class="grd-delete" th:data-table-id="${tableId}" th:id="'grd-delete-' + ${tableId}" style="display: none;">삭제</button>
        </div>
    </div>

    <hr class="grid-divider">

    <table th:id="${tableId}" class="table table-striped table-bordered">
        <thead>
        <tr id="tableHeader"></tr>
        </thead>
    </table>

    <script th:inline="javascript">
        if (!window.tableInstances) {
            window.tableInstances = {};  // 여러 개의 DataTable을 저장할 객체
        }

        // CRUD 코드 매핑 (C = Create(Add), U = Update(Save), D = Delete)
        if (!window.crudActionMap) {
            window.crudActionMap = {
                "C": "add",
                "U": "save",
                "D": "delete",
                "A": "active"
            };
        }

        window.grid = function (tableId, dataUrl, crudActions = '') {
            if (!tableId || !dataUrl) {
                console.error("tableId 또는 dataUrl이 없습니다.");
                return;
            }

            /* CRUD 버튼 표시 여부 처리 */
            if (crudActions.trim() !== '') {
                let actionsArray = crudActions.split("");
                actionsArray.forEach(action => {
                    let mappedAction = window.crudActionMap[action.trim().toUpperCase()]; // C → add, U → save, D → delete
                    if (mappedAction) {
                        let button = document.querySelector(`.grd-${mappedAction}[data-table-id="${tableId}"]`);
                        if (button) {
                            if(mappedAction === "active"){
                                $.ajax({
                                    url: `/isApprovalAvailable`,
                                    type: "GET",
                                    success: function (response) {
                                        if(response.result){
                                            button.style.display = "inline-block";
                                        }
                                    }
                                })
                            }else{
                                button.style.display = "inline-block";
                            }
                        }
                    }
                });
            }

            if (window.tableInstances[tableId]) {
                return;
            }

            $.ajax({
                url: `${dataUrl}/column`,
                type: "GET",
                success: function (columns) {
                    let headerRow = $("#" + tableId + " thead tr");
                    headerRow.empty();
                    let $select = $(`#search-column-${tableId}`);
                    $select.empty();

                    let hasSearchableColumn = false;

                    columns.forEach(col => {
                        headerRow.append(`<th>${col.columnName}</th>`);
                        if(col.isSearch){
                            let optionHtml = `<option value="${col.column}" data-type="${col.columnType}">${col.columnName}</option>`;
                            $select.append(optionHtml);
                            hasSearchableColumn = true;
                        }
                    });

                    // 검색 컬럼 변경 시, 입력 타입 변경 (숫자/문자 필드 전환)
                    $select.on("change", function () {
                        let selectedType = $(this).find("option:selected").attr("data-type");
                        let $textInput = $(`#search-input-text-${tableId}`);
                        let $numberInput = $(`#search-input-number-${tableId}`);

                        if (selectedType === "NUMBER") {
                            $textInput.hide();
                            $numberInput.show().val("");
                        } else {
                            $numberInput.hide();
                            $textInput.show().val("");
                        }
                    });

                    // 검색 컬럼이 없는 경우 검색어 입력 필드 & 조회 버튼 숨김
                    if (!hasSearchableColumn) {
                        $select.hide();
                        $(`#search-input-text-${tableId}`).hide();
                        $(`#search-input-number-${tableId}`).hide();
                        $(`#search-column-${tableId}`).hide();
                    } else {
                        $select.show();
                        $(`#grd-select-${tableId}`).show();
                        $select.trigger("change"); // 기본 컬럼 선택 적용
                    }

                    // DataTables 초기화
                    window.tableInstances[tableId] = $("#" + tableId).DataTable({
                        "processing": true,
                        "serverSide": true,
                        "searching": false,
                        "info": false,
                        "destroy": true,
                        "language": {
                            "lengthMenu": "페이지당 _MENU_ 행 표시",
                            "zeroRecords": "검색된 데이터가 없습니다.",
                            "info": "총 _TOTAL_ 개의 항목",
                            "infoEmpty": "표시할 데이터가 없습니다.",
                            "emptyTable": "조회된 데이터가 없습니다.",
                            "infoFiltered": "(전체 _MAX_ 개의 항목 중 필터링됨)",
                            "paginate": {
                                "first": "처음",
                                "last": "마지막",
                                "next": "다음",
                                "previous": "이전"
                            }
                        },
                        "ajax": {
                            "url": `${dataUrl}/data`,
                            "type": "GET",
                            "data": function (d) {
                                let column = $(`#search-column-${tableId}`).val();
                                let selectedType = $(`#search-column-${tableId}`).find("option:selected").attr("data-type");
                                let query = selectedType === "NUMBER"
                                    ? $(`#search-input-number-${tableId}`).val()
                                    : $(`#search-input-text-${tableId}`).val();

                                return {
                                    page: d.start / d.length,
                                    size: d.length,
                                    searchQuery: query,
                                    searchColumn: column,
                                    sort: d.order
                                        .filter(order => columns[order.column])
                                        .map(order => {
                                            let columnName = columns[order.column].column || "timestamp";
                                            let direction = order.dir === "asc" ? "asc" : "desc";
                                            return columnName + "," + direction;
                                        })
                                        .join(";")
                                };
                            }
                        },
                        "columns": columns.map(col => ({
                            "data": col.column,
                            "title": col.columnName,
                            "render": function (data, type, row) {
                                switch (col.rowType) {
                                    case "TEXT":
                                        return `<p>${data}</p>`;
                                    case "INPUT":
                                        return `<input type="text" class="form-control edit-input" value="${data}" data-id="${row.id}" data-field="${col.column}">`;
                                    case "BUTTON":
                                        return `<button class="btn btn-sm ${col.class || 'btn-primary'} action-btn" data-id="${row.id}" data-field="${col.column}">${data}</button>`;
                                    case "SELECT":
                                        let options = col.options.map(option =>
                                            `<option value="${option}" ${data === option ? 'selected' : ''}>${option}</option>`
                                        ).join("");
                                        return `<select class="form-control edit-select" data-id="${row.id}" data-field="${col.column}">${options}</select>`;
                                    case "DATE":
                                        return `<input type="text" class="form-control datepicker" value="${data}" data-id="${row.id}" data-field="${col.column}">`;
                                    case "CHECKBOX":
                                        return `<input type="checkbox" class="row-checkbox" data-id="${row.id}">`;
                                    default:
                                        return data || "";
                                }
                            }
                        }))
                    });

                    // 초기에 선택된 컬럼 타입 반영 (기본값)
                    if(hasSearchableColumn) $select.trigger("change");
                },
                error: function (error) {
                    console.error("데이터 불러오기 실패:", error);
                }
            });
        };

        $(document).on("click", ".grd-select", function () {
            let tableId = $(this).attr("data-table-id");
            searchGrid(tableId);
        });

        function searchGrid(tableId) {
            if (!window.tableInstances[tableId]) {
                console.warn(`테이블 ${tableId} 인스턴스가 없습니다.`);
                return;
            }
            window.tableInstances[tableId].ajax.reload(null, false);
        }

        window.searchGrid = searchGrid;

        $(document).ready(() => {
            let tableId = /*[[${tableId}]]*/ '';
            let dataUrl = /*[[${dataUrl}]]*/ '';
            let crudActions = /*[[${crudActions} ?: '']]*/ '';

            window.grid(tableId, dataUrl, crudActions);
        });

        $(".search-input-number").on("keydown", function (event) {
            if (event.key === "e" || event.key === "E" || event.key === "+" || event.key === "-") {
                event.preventDefault();
            }
        });
    </script>
</div>
